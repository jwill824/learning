name: GitHub Foundations Wiki Generator

on:
  push:
    paths:
      - 'github_foundations/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  generate-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch master

      - name: Create Wiki content
        run: |
          mkdir -p wiki
          # Generate index page
          echo "# GitHub Foundations Wiki" > wiki/Home.md
          echo "\nThis wiki is automatically generated from the github_foundations modules.\n" >> wiki/Home.md
          
          # Generate sidebar navigation
          echo "# Navigation" > wiki/_Sidebar.md
          
          # Process modules
          for file in github_foundations/modules/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              title=$(head -n 1 "$file" | sed 's/^# //')
              
              # Create wiki page
              cp "$file" "wiki/${filename}.md"
              
              # Add to sidebar
              echo "* [${title}](${filename})" >> wiki/_Sidebar.md
              
              # Add to index
              echo "* [${title}](${filename})" >> wiki/Home.md
            fi
          done

      - name: Push to Wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd wiki
          git init
          git checkout -b master
          git add .
          
          # First-time initialization or update
          git commit -m "Update wiki content"
          echo "Attempting to push wiki content..."
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.wiki.git"
          
          # Try normal push first (works for existing wikis)
          if git push -f origin master; then
            echo "Wiki updated successfully!"
            exit 0
          fi
          
          # If first push failed, wiki might not exist - try to initialize
          echo "First push failed, attempting to initialize wiki..."
          echo "# Welcome" > README.md
          git add README.md
          git commit -m "Initialize wiki"
          
          if git push -f origin master; then
            echo "Wiki initialized successfully! Updating content..."
            # Now push the actual content
            git reset --hard HEAD^
            git add .
            git commit -m "Add wiki content"
            git push -f origin master
          else
            echo "Error: Failed to initialize wiki. Please check:"
            echo "1. Wiki is enabled in repository settings"
            echo "2. GITHUB_TOKEN has wiki write permission"
            echo "3. Repository path is correct"
            exit 1
          fi
