name: GitHub Foundations Wiki Generator

on:
  push:
    paths:
      - 'github_foundations/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  generate-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch master

      - name: Create Wiki content
        run: |
          mkdir -p wiki
          # Generate index page
          echo "# GitHub Foundations Wiki" > wiki/Home.md
          echo "\nThis wiki is automatically generated from the github_foundations modules.\n" >> wiki/Home.md
          
          # Generate sidebar navigation
          echo "# Navigation" > wiki/_Sidebar.md
          
          # Process modules
          for file in github_foundations/modules/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              title=$(head -n 1 "$file" | sed 's/^# //')
              
              # Create wiki page
              cp "$file" "wiki/${filename}.md"
              
              # Add to sidebar
              echo "* [${title}](${filename})" >> wiki/_Sidebar.md
              
              # Add to index
              echo "* [${title}](${filename})" >> wiki/Home.md
            fi
          done

      - name: Push to Wiki
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.repository }}
        run: |
          cd wiki
          git init
          git checkout -b master
          git add .
          git commit -m "Update wiki content"
          
          # Ensure proper URL formatting
          REPO_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO_NAME}.wiki.git"
          echo "Using repository URL: ${REPO_URL//${GITHUB_TOKEN}/***}"
          
          git remote add origin "${REPO_URL}"
          
          # Try pushing with debug output
          if git push -v -f origin master; then
            echo "Wiki updated successfully!"
            exit 0
          fi
          
          # If push failed, try alternative initialization
          echo "First push failed, verifying repository..."
          curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${REPO_NAME}"
          
          if [ $? -eq 0 ]; then
            echo "Repository exists but wiki push failed. Ensure:"
            echo "1. Wiki is enabled in repository settings at:"
            echo "   https://github.com/${REPO_NAME}/settings/features"
            echo "2. GITHUB_TOKEN has 'repo' scope"
          else
            echo "Repository not found. Check repository name: ${REPO_NAME}"
          fi
          exit 1
