name: GitHub Foundations Wiki Generator

on:
  push:
    paths:
      - 'github_foundations/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  generate-wiki:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global init.defaultBranch master

      - name: Create Wiki content
        run: |
          mkdir -p wiki
          # Generate index page
          echo "# GitHub Foundations Wiki" > wiki/Home.md
          echo "\nThis wiki is automatically generated from the github_foundations modules.\n" >> wiki/Home.md
          
          # Generate sidebar navigation
          echo "# Navigation" > wiki/_Sidebar.md
          
          # Process modules
          for file in github_foundations/modules/*.md; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .md)
              title=$(head -n 1 "$file" | sed 's/^# //')
              
              # Create wiki page
              cp "$file" "wiki/${filename}.md"
              
              # Add to sidebar
              echo "* [${title}](${filename})" >> wiki/_Sidebar.md
              
              # Add to index
              echo "* [${title}](${filename})" >> wiki/Home.md
            fi
          done

      - name: Push to Wiki
        env:
          GH_PAT: ${{ secrets.GH_PAT }}  # Use PAT instead of GITHUB_TOKEN
          REPO_NAME: ${{ github.repository }}
        run: |
          cd wiki
          git init
          git checkout -b master
          git add .
          git commit -m "Update wiki content"
          
          # Use PAT for authentication
          REPO_URL="https://${GH_PAT}@github.com/${REPO_NAME}.wiki.git"
          echo "Using repository URL: ${REPO_URL//${GH_PAT}/***}"
          
          git remote add origin "${REPO_URL}"
          
          if git push -v -f origin master; then
            echo "Wiki updated successfully!"
            exit 0
          else
            echo "Push failed. Please ensure:"
            echo "1. You have created a Personal Access Token (PAT) with 'repo' scope:"
            echo "   https://github.com/settings/tokens/new?scopes=repo&description=Wiki+Access"
            echo "2. Added the PAT as 'GH_PAT' secret in repository settings:"
            echo "   https://github.com/${REPO_NAME}/settings/secrets/actions"
            echo "3. Wiki is enabled in repository settings"
            exit 1
          fi
